- hosts: domain_controllers

  vars:
    parent_ou: Parent_OU
    ous:
      - Demo Domain Member Servers
      - Demo Domain Groups
      - Demo Domain Machines
      - Demo Domain Users

    adgroups:
      - Azure Admins
      - Azure Users

  tasks:

    - name: Create new Windows domain in a new forest with specific parameters and reboot in post task
      microsoft.ad.domain:
        create_dns_delegation: false
        database_path: C:\Windows\NTDS
        dns_domain_name: ansible-poc.local
        domain_mode: WinThreshold
        domain_netbios_name: ansible-poc
        forest_mode: WinThreshold
        safe_mode_password: 1QAZ2wsx3edc
        sysvol_path: C:\Windows\SYSVOL
      register: domain_install

    - name: Reboot host if install requires it
      ansible.windows.win_reboot:
      when: domain_install.reboot_required

    - name: Ensure OUs are present
      microsoft.ad.ou:
        name: "{{ item }}"
        state: present
        protect_from_deletion: false
        description: "Created via Ansible"
      loop: "{{ ous }}"

    - name: Ensure AD Groups are present
      microsoft.ad.group:
        name: "{{ item }}"
        scope: global
        category: security
        path: OU=Demo Domain Groups,DC=ansible-poc,DC=local
        state: present
      loop: "{{ adgroups }}"